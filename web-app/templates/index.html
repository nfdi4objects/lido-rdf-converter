<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="{{url_for('static',filename='lidostyle.css')}}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>
  <title>X3ML Editor</title>
</head>

<body>

  <!-- Main dialog Item connected to vue-app -->
  <div id="app" class="container">
    <!-- Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="uploadModalLabel">Uploading X3ml mappings</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form novalidate @submit.prevent="onSubmit">
              <div class="input-group mb-3">
                <input type="file" class="form-control" @change="addX3mlFile" />
                <input type="submit" class="btn btn-primary" data-bs-dismiss="modal" value="Submit" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <h3>Mapping (x3ml)</h3>
        <div id="acc" class="accordion accordion-flush" style="overflow-y: scroll; height:600px">
          <div class="accordion-item" v-for="(mapping, i) in x3ml.mappings" :key="i">
            <h2 class="accordion-header" :id="'M' + i">
              <button class="accordion-button" type="button" data-bs-toggle="collapse" :data-bs-target="'#C' + i"
                aria-expanded="false" :aria-controls="'C' + i">
                Mapping ${i+1}$ from: "${mapping.domain.sourceNode.text.replace("lido:", "")}$"
              </button>
            </h2>
            <div :id="'C' + i" class="accordion-collapse collapse hide" :aria-labelledby="'M' + i"
              data-bs-parent="#acc">
              <div class="accordion-body">

                <div class="container-fluid">
                  <label for="fname">Path:</label>
                  <input class="form-control" type="text" name="S-path" :id="i"
                    v-model="mapping.domain.sourceNode.text">
                  <label for="lname">Entity:</label>
                  <input class="form-control" type="text" name="S-type" :id="i"
                    v-model="mapping.domain.targetNode.entity.type">
                  <br />
                  <p>
                    <button type="button" class="btn btn-primary btn-sm" @click="applyMap" :iM="i">Submit</button>&nbsp;
                    <button type="button" class="btn btn-primary btn-sm" @click="addLink" :iM="i">Add
                      Link</button>&nbsp;
                    <button type="button" class="btn btn-danger btn-sm" @click="deleteMap" :iM="i">Delete</button>&nbsp;
                  </p>
                </div>

                <div class="accordion accordion-flush" :id="'LA' + i">
                  <div class="accordion-item" v-for="(link, j) in mapping.links" :key="j">
                    <h2 class="accordion-header" :id="'L' + j">
                      <button class="accordion-button" type="button" data-bs-toggle="collapse"
                        :data-bs-target="'#D' + j" aria-expanded="false" :aria-controls="'D' + j">
                        Link ${j+1}$: "${link.path.sourceRelation.relation.replace("lido:", "")}$"
                      </button>
                    </h2>
                    <div :id="'D' + j" class="accordion-collapse collapse hide" :aria-labelledby="'L' + j"
                      :data-bs-parent="'#LA' + i">
                      <div class="accordion-body">
                        <form method="post">
                          <label for="fname">Path:</label>
                          <input class="form-control" type="text" name="P-path" :id="j"
                            v-model="link.path.sourceRelation.relation">
                          <label for="lname">Property</label>
                          <input class="form-control" type="text" name="P-type" :id="j"
                            v-model="link.path.targetRelation.relationship.value">
                          <label for="lname">Entity</label>
                          <input class="form-control" type="text" name="P-type" :id="j"
                            v-model="link.range.targetNode.entity.type">
                          <br />
                          <button type="button" class="btn btn-primary btn-sm" @click="applyLink" :iM="i"
                            :iL="j">Submit</button>&nbsp;
                          <button type="button" class="btn btn-danger btn-sm" @click="deleteLink" :iM="i"
                            :iL="j">Delete</button>&nbsp;
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <br />
        <p>
          <button type="button" class="btn btn-primary btn-sm" @click="addMapping">Add mapping</button>&nbsp;
          <button type="button" class="btn btn-success btn-sm" @click="runMappings">Apply mappings</button>&nbsp;
          <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#uploadModal">
            Upload</button>
        </p>
      </div>
      <div class="col">
        <h3>Lido-Sample (xml)</h3>
        <div id="editor" style="height:600px"></div>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="row">
      <div class="col">
        <h3>RDF Output (ttl)</h3>
        <div id="output">y1</div>
      </div>
    </div>
  </div>

  <script>
    $('#myModal').on('shown.bs.modal', function () {
      $('#myInput').trigger('focus')
    })
    function clone(o) {
      return JSON.parse(JSON.stringify(o))
    }
    async function post(url, data) {
      headers = { 'Accept': 'application/json, text/plain, */*', 'Content-Type': 'application/json' }
      req = { method: 'POST', headers: headers, body: JSON.stringify(data) }
      return await fetch(url, req)
    }

    async function get(url) {
      headers = { 'Accept': 'application/json, text/plain, */*', 'Content-Type': 'application/json' }
      req = { method: 'GET', headers: headers }
      return await fetch(url, req)
    }

    var app = Vue.createApp({
      data() { return { x3ml: {}, lido: '', x3file: null } },
      delimiters: ["${", "}$"], // for global
      compilerOptions: { delimiters: ["${", "}$"] }, // for standalone
      methods: {
        addX3mlFile(event) {
          this.x3file = event.target.files[0];
        },
        onSubmit() {
          if (this.x3file) {
            this.x3file.text()
              .then((s) => {
                post('/uploadMapping', { type: 'uploadMapping', data: s })
                  .then((res) => {
                    this.getX3ml();
                    this.x3file = null
                  });
              })
          }
        },
        getX3ml() {
          get("/x3ml")
            .then((response) => response.json())
            .then((s) => { this.x3ml = JSON.parse(s.jsonX3ml) })
            .catch((err) => { console.error(err); });
        },
        getLido() {
          get("/loadLido")
            .then((response) => response.json())
            .then((s) => { sourceEditor.setValue(s.lidoData); })
            .catch((err) => { console.error(err); })
        },
        addMapping(event) {
          if (event) {
            data = { type: 'addMapping', mIndex: -1 }
            post('/addMap', data).then(res => res.json());
            // Sync
            this.getX3ml()
          }
        },
        deleteMap(event) {
          if (event) {
            attrs = event.target.attributes
            mIndex = attrs.iM.value
            // Delete mapping on server
            fetch('/deleteMap/' + mIndex, { method: 'DELETE' })
            // Sync
            this.getX3ml()
          }
        },
        applyMap(event) {
          if (event) {
            attrs = event.target.attributes
            mIndex = attrs.iM.value
            mapping = this.x3ml.mappings[mIndex]
            data = {
              type: 'mapping',
              mIndex: mIndex,
              path: mapping.domain.sourceNode.text,
              entity: mapping.domain.targetNode.entity.type
            }
            post('/x3ml', data).then(res => res.json());
            this.runMappings(event)
          }
        },
        applyLink(event) {
          if (event) {
            attrs = event.target.attributes
            mIndex = attrs.iM.value
            lIndex = attrs.iL.value
            link = this.x3ml.mappings[mIndex].links[lIndex]
            data = {
              type: 'link',
              mIndex: mIndex,
              lIndex: lIndex,
              path: link.path.sourceRelation.relation,
              relationship: link.path.targetRelation.relationship.value,
              entity: link.range.targetNode.entity.type
            }
            post('/x3ml', data).then(res => res.json());
            this.runMappings(event)
          }
        },
        deleteLink(event) {
          if (event) {
            attrs = event.target.attributes
            mIndex = attrs.iM.value
            lIndex = attrs.iL.value
            // Delete link on server
            fetch('/deleteLink/' + mIndex + '/' + lIndex, { method: 'DELETE' })
            // Sync
            this.getX3ml()
          }
        },
        addLink(event) {
          if (event) {
            attrs = event.target.attributes
            mIndex = attrs.iM.value
            data = { type: 'addLink', mIndex: mIndex, lIndex: -1 }
            post('/addLink', data).then(res => res.json());
            // Sync
            this.getX3ml()
          }
        },
        runMappings(event) {
          if (event) {
            data = { type: '/runMappings', data: sourceEditor.getValue() }
            post('/runMappings', data)
              .then(res => res.json())
              .then(s => outputDisplay.setValue(s.text));
            // Sync
            this.getX3ml()
          }
        }
      },
      created() {
        this.getX3ml();
        this.getLido();
      }
    }).mount('#app');

    function makeEdit(label, style = "ace/theme/monokai", fmt = "ace/mode/xml") {
      var ed = ace.edit(label);
      ed.setTheme(style);
      ed.session.setMode(fmt);
      ed.setPrintMarginColumn(-1)
      return ed;
    }
    var sourceEditor = makeEdit("editor");
    sourceEditor.setValue(app.lido)
    var outputDisplay = makeEdit("output", "", "ace/mode/turtle");
    outputDisplay.setOptions({ "readOnly": true })

  </script>
</body>

</html>